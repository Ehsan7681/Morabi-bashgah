<!DOCTYPE html>
<html lang="fa" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مربی جمینی اولترا مکس | Ultra Max</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        darkBg: '#111827',
                        lightBg: '#f8fafc',
                    },
                    fontFamily: {
                        sans: ['Vazirmatn', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <style>
        body { font-family: 'Vazirmatn', sans-serif; }
        
        /* Markdown Styling (V3 Style) */
        .prose h1, .prose h2, .prose h3 { color: #3b82f6; margin-top: 1em; margin-bottom: 0.5em; font-weight: bold; }
        .dark .prose h1, .dark .prose h2, .dark .prose h3 { color: #60a5fa; }
        .prose ul { list-style-type: disc; padding-right: 1.5em; margin-bottom: 1em; }
        .prose table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.9em; border-radius: 8px; overflow: hidden; }
        .prose th, .prose td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right; }
        .dark .prose th, .dark .prose td { border-bottom: 1px solid #374151; }
        .prose th { background-color: #f1f5f9; color: #334155; }
        .dark .prose th { background-color: #1f2937; color: #93c5fd; }
        .prose tr:nth-child(even) { background-color: #f8fafc; }
        .dark .prose tr:nth-child(even) { background-color: rgba(255,255,255,0.02); }

        /* Print Specific Styles */
        @media print {
            body { background-color: white !important; color: black !important; }
            header, #input-area, .no-print, #settings-modal, #plan-modal, #export-modal, #sidebar-toggle, #sidebar-container { display: none !important; }
            #main-layout { width: 100% !important; margin: 0 !important; }
            #chat-container { overflow: visible !important; height: auto !important; position: static !important; }
            #messages-list { display: block !important; padding-bottom: 0 !important; }
            .message-bubble { 
                box-shadow: none !important; 
                border: 1px solid #ccc !important; 
                background-color: white !important; 
                color: black !important;
                max-width: 100% !important;
                page-break-inside: avoid;
            }
            ::-webkit-scrollbar { display: none; }
        }
        
        /* Sidebar Animations */
        #sidebar-container { transition: width 0.3s ease, transform 0.3s ease; }
        .sidebar-open #sidebar-container { transform: translateX(0); }
        .sidebar-closed #sidebar-container { transform: translateX(100%); } /* RTL: push right */
        
        @media (min-width: 1024px) {
            .sidebar-closed #sidebar-container { width: 0; transform: none; overflow: hidden; }
            .sidebar-open #sidebar-container { width: 300px; transform: none; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
    </style>
</head>
<body class="bg-lightBg dark:bg-darkBg text-gray-800 dark:text-gray-200 h-screen flex overflow-hidden transition-colors duration-300 sidebar-closed lg:sidebar-open">

    <!-- Sidebar (History) -->
    <aside id="sidebar-container" class="fixed inset-y-0 right-0 z-40 w-72 bg-white dark:bg-gray-900 border-l dark:border-gray-700 shadow-2xl lg:shadow-none lg:static flex flex-col shrink-0 h-full">
        <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
            <h2 class="font-bold text-gray-700 dark:text-gray-200 flex items-center gap-2">
                <i class="fa-solid fa-clock-rotate-left text-blue-500"></i> تاریخچه
            </h2>
            <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        
        <div class="p-3">
            <button onclick="startNewChat()" class="w-full bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/40 text-blue-600 dark:text-blue-400 p-3 rounded-xl border border-blue-200 dark:border-blue-800 flex items-center justify-center gap-2 transition font-medium text-sm">
                <i class="fa-solid fa-plus"></i> گفتگوی جدید
            </button>
        </div>

        <div id="history-list" class="flex-1 overflow-y-auto p-3 space-y-2">
            <!-- Items injected by JS -->
        </div>
        
        <div class="p-3 text-[10px] text-center text-gray-400 border-t dark:border-gray-700">
            تاریخچه در مرورگر ذخیره می‌شود
        </div>
    </aside>

    <!-- Overlay for Mobile -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- Main Content -->
    <div id="main-layout" class="flex-1 flex flex-col h-full relative w-full min-w-0">

        <!-- Header (V3 Design) -->
        <header class="bg-white dark:bg-gray-800 p-3 shadow-md flex justify-between items-center z-30 shrink-0">
            <div class="flex items-center gap-2">
                <button onclick="toggleSidebar()" class="w-10 h-10 mr-[-0.5rem] rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center lg:hidden">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fa-solid fa-dumbbell"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">مربی اولترا مکس</h1>
                    <p class="text-[10px] text-gray-500 dark:text-gray-400" id="model-badge">مدل: ...</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openExportModal()" class="w-9 h-9 rounded-lg bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 hover:bg-green-100 transition flex items-center justify-center" title="ذخیره و خروجی">
                    <i class="fa-solid fa-file-export"></i>
                </button>
                <button onclick="toggleTheme()" class="w-9 h-9 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition flex items-center justify-center">
                    <i class="fa-solid fa-sun dark:hidden text-orange-400"></i>
                    <i class="fa-solid fa-moon hidden dark:block text-blue-300"></i>
                </button>
                <button onclick="openSettings()" class="w-9 h-9 rounded-lg bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-100 transition flex items-center justify-center">
                    <i class="fa-solid fa-gear"></i>
                </button>
                <button onclick="toggleSidebar()" class="hidden lg:flex w-9 h-9 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 transition items-center justify-center" title="تاریخچه">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                </button>
            </div>
        </header>

        <!-- Chat Area -->
        <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 relative scroll-smooth">
            
            <!-- Welcome State (V3 Design) -->
            <div id="welcome-screen" class="flex flex-col items-center justify-center min-h-[70vh] text-center animate-fade-in px-4">
                <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl border border-gray-100 dark:border-gray-700 max-w-md w-full transform transition hover:scale-[1.01]">
                    <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900/50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fa-solid fa-robot text-4xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-3">باشگاه هوشمند شما</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-8 leading-relaxed">
                        برنامه‌نویسی تمرینی، رژیم غذایی و آنالیز تخصصی با قدرت هوش مصنوعی جمینی.
                    </p>
                    <div class="space-y-3">
                        <button onclick="openSettings()" class="w-full py-3.5 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 font-medium hover:border-blue-500 hover:text-blue-500 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-key"></i> تنظیم API Key
                        </button>
                        <button onclick="openPlanForm()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus-circle"></i> ساخت برنامه جدید
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div id="messages-list" class="hidden flex flex-col gap-6 pb-20"></div>
        </main>

        <!-- Input Area (V3 Design) -->
        <div id="input-area" class="bg-white dark:bg-gray-800 p-3 border-t border-gray-200 dark:border-gray-700 z-20 shrink-0">
            <div class="max-w-4xl mx-auto flex gap-2 items-end">
                <button onclick="openPlanForm()" class="h-12 w-12 rounded-xl text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition flex items-center justify-center shrink-0" title="فرم برنامه نویسی">
                    <i class="fa-solid fa-clipboard-list text-xl"></i>
                </button>
                <textarea id="user-input" rows="1" placeholder="پیام خود را بنویسید..." 
                    class="flex-1 bg-gray-100 dark:bg-gray-900 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none max-h-32 text-sm border-0 leading-6"
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                    onkeypress="handleEnter(event)"></textarea>
                <button onclick="sendMessage()" class="h-12 w-12 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-600/20 flex items-center justify-center shrink-0">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>

    </div>

    <!-- Export Modal (V3 Feature) -->
    <div id="export-modal" class="hidden fixed inset-0 bg-black/70 z-[60] flex items-end sm:items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-sm p-6 shadow-2xl border dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <i class="fa-solid fa-share-nodes text-green-500"></i> خروجی گرفتن
                </h3>
                <button onclick="closeModal('export-modal')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="exportToImage()" class="flex flex-col items-center justify-center p-4 rounded-xl bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 border border-gray-200 dark:border-gray-600 transition group">
                    <i class="fa-solid fa-image text-2xl text-purple-500 mb-2 group-hover:scale-110 transition"></i>
                    <span class="text-sm font-medium">تصویر (PNG)</span>
                    <span class="text-[10px] text-gray-500 mt-1">بهترین برای اینستاگرام</span>
                </button>

                <button onclick="exportToPDF()" class="flex flex-col items-center justify-center p-4 rounded-xl bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 border border-gray-200 dark:border-gray-600 transition group">
                    <i class="fa-solid fa-file-pdf text-2xl text-red-500 mb-2 group-hover:scale-110 transition"></i>
                    <span class="text-sm font-medium">پی‌دی‌اف (PDF)</span>
                    <span class="text-[10px] text-gray-500 mt-1">کیفیت چاپ بالا</span>
                </button>

                <button onclick="exportToHTML()" class="flex flex-col items-center justify-center p-4 rounded-xl bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 border border-gray-200 dark:border-gray-600 transition group">
                    <i class="fa-brands fa-html5 text-2xl text-orange-500 mb-2 group-hover:scale-110 transition"></i>
                    <span class="text-sm font-medium">ذخیره فایل</span>
                    <span class="text-[10px] text-gray-500 mt-1">نسخه کامل آفلاین</span>
                </button>

                <button onclick="exportToText()" class="flex flex-col items-center justify-center p-4 rounded-xl bg-gray-50 dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-blue-900/30 border border-gray-200 dark:border-gray-600 transition group">
                    <i class="fa-solid fa-file-lines text-2xl text-gray-500 mb-2 group-hover:scale-110 transition"></i>
                    <span class="text-sm font-medium">متن (TXT)</span>
                    <span class="text-[10px] text-gray-500 mt-1">فقط نوشته‌ها</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6 shadow-2xl h-auto max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">تنظیمات هوش مصنوعی</h3>
                <button onclick="closeModal('settings-modal')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-bold text-gray-600 dark:text-gray-300">API Key های شما</label>
                        <button onclick="addApiKeyInput()" class="text-xs text-blue-500 font-bold hover:underline">+ افزودن کلید</button>
                    </div>
                    <div id="api-keys-list" class="space-y-2 max-h-32 overflow-y-auto pr-1">
                        <!-- Dynamic Inputs -->
                    </div>
                </div>

                <div class="pt-2 border-t dark:border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-bold text-gray-600 dark:text-gray-300">مدل جمینی</label>
                        <button onclick="fetchModels()" id="fetch-btn" class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-2 py-1 rounded flex items-center gap-1">
                            <i class="fa-solid fa-cloud-arrow-down"></i> دریافت همه مدل‌ها
                        </button>
                    </div>
                    <select id="model-select" class="w-full bg-gray-100 dark:bg-gray-900 rounded-xl px-3 py-3 text-sm ltr-text border-none focus:ring-2 focus:ring-blue-500">
                        <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
                        <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                        <option value="gemini-1.5-pro">gemini-1.5-pro</option>
                    </select>
                </div>

                <button onclick="saveSettings()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl mt-4 transition">ذخیره تنظیمات</button>
            </div>
        </div>
    </div>

    <!-- Advanced Plan Modal -->
    <div id="plan-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-t-3xl sm:rounded-2xl w-full max-w-2xl h-[90vh] sm:h-[80vh] flex flex-col shadow-2xl">
            <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold text-blue-600 dark:text-blue-400">طراحی برنامه تمرینی</h3>
                <button onclick="closeModal('plan-modal')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 space-y-6">
                <!-- Personal Info -->
                <div class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-xl border border-gray-100 dark:border-gray-700">
                    <h4 class="text-sm font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-user text-gray-400"></i> مشخصات فردی</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <select id="p-gender" class="input-field"><option>مرد</option><option>زن</option></select>
                        <input type="number" id="p-age" placeholder="سن" class="input-field">
                        <input type="number" id="p-weight" placeholder="وزن (kg)" class="input-field">
                        <input type="number" id="p-height" placeholder="قد (cm)" class="input-field">
                    </div>
                    <div class="mt-3">
                        <label class="block text-xs text-gray-500 mb-1">سطح آمادگی</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label class="cursor-pointer text-center"><input type="radio" name="level" value="مبتدی" checked class="peer sr-only"><span class="block p-2 rounded-lg bg-white dark:bg-gray-800 border peer-checked:bg-green-500 peer-checked:text-white text-xs transition">مبتدی</span></label>
                            <label class="cursor-pointer text-center"><input type="radio" name="level" value="متوسط" class="peer sr-only"><span class="block p-2 rounded-lg bg-white dark:bg-gray-800 border peer-checked:bg-yellow-500 peer-checked:text-white text-xs transition">متوسط</span></label>
                            <label class="cursor-pointer text-center"><input type="radio" name="level" value="حرفه‌ای" class="peer sr-only"><span class="block p-2 rounded-lg bg-white dark:bg-gray-800 border peer-checked:bg-red-500 peer-checked:text-white text-xs transition">حرفه‌ای</span></label>
                        </div>
                    </div>
                </div>

                <!-- Workout Details -->
                <div class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-xl border border-gray-100 dark:border-gray-700">
                    <h4 class="text-sm font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-dumbbell text-gray-400"></i> جزئیات تمرین</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                        <select id="p-goal" class="input-field">
                            <option>عضله سازی (Hypertrophy)</option>
                            <option>چربی سوزی (Fat Loss)</option>
                            <option>افزایش قدرت (Strength)</option>
                            <option>اصلاح پاسچر (Posture)</option>
                        </select>
                        <select id="p-days" class="input-field">
                            <option value="3">3 روز در هفته</option>
                            <option value="4" selected>4 روز در هفته</option>
                            <option value="5">5 روز در هفته</option>
                            <option value="6">6 روز در هفته</option>
                        </select>
                    </div>
                    <input type="text" id="p-equip" placeholder="تجهیزات: (مثلا: دمبل خونه، کامل باشگاه، هیچ...)" class="input-field w-full mb-3">
                    <input type="text" id="p-injury" placeholder="آسیب دیدگی (اختیاری): کمردرد، زانو..." class="input-field w-full bg-red-50 dark:bg-red-900/10 border-red-100 dark:border-red-900/30 placeholder-red-300">
                </div>

                <!-- Extras -->
                <div class="flex items-center justify-between bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl border border-blue-100 dark:border-blue-900/30">
                    <span class="text-sm text-blue-800 dark:text-blue-300">توضیح آموزشی حرکات</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="p-explain" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>

            <div class="p-4 bg-white dark:bg-gray-800 border-t dark:border-gray-700 shrink-0">
                <button onclick="submitPlan()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg flex justify-center items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    تولید برنامه هوشمند
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Globals ---
        let apiKeys = JSON.parse(localStorage.getItem('gemini_api_keys') || '[]');
        let activeKeyIndex = parseInt(localStorage.getItem('gemini_active_idx') || '0');
        let selectedModel = localStorage.getItem('gemini_model') || 'gemini-1.5-flash';
        
        // History Logic
        let sessions = JSON.parse(localStorage.getItem('gemini_sessions') || '[]');
        let currentSessionId = null; 
        let currentMessages = [];

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            const theme = localStorage.getItem('theme');
            if (theme === 'light') document.documentElement.classList.remove('dark');
            
            updateModelBadge();
            renderSettingsKeys();
            renderHistory();
            
            // Auto open settings if no keys
            if(apiKeys.length === 0 || !apiKeys[0]) setTimeout(() => openSettings(), 500);
            
            // Check if user has chats
            if(sessions.length === 0) startNewChat(false);
        });

        // --- UI Utils ---
        const $ = id => document.getElementById(id);
        const toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        };
        const closeModal = id => $(id).classList.add('hidden');
        const openModal = id => $(id).classList.remove('hidden');
        
        // Sidebar Logic
        function toggleSidebar() {
            const body = document.body;
            const overlay = $('sidebar-overlay');
            if(body.classList.contains('sidebar-closed')) {
                body.classList.remove('sidebar-closed');
                body.classList.add('sidebar-open');
                overlay.classList.remove('hidden');
            } else {
                body.classList.remove('sidebar-open');
                body.classList.add('sidebar-closed');
                overlay.classList.add('hidden');
            }
        }

        function openSettings() { 
            renderSettingsKeys(); 
            $( 'model-select' ).value = selectedModel;
            openModal('settings-modal'); 
        }
        
        function openPlanForm() {
            if(!getApiKey()) return alert('لطفا ابتدا API Key را وارد کنید');
            openModal('plan-modal');
        }

        function openExportModal() {
            if ($('messages-list').innerHTML.trim() === '') return alert('هنوز برنامه ای برای ذخیره وجود ندارد!');
            openModal('export-modal');
        }

        // --- History / Sessions ---
        function startNewChat(clearUI = true) {
            currentSessionId = Date.now().toString();
            currentMessages = [];
            
            if (clearUI) {
                $('messages-list').innerHTML = '';
                $('messages-list').classList.add('hidden');
                $('welcome-screen').classList.remove('hidden');
                
                // Close sidebar on mobile
                if(window.innerWidth < 1024) {
                    document.body.classList.add('sidebar-closed');
                    document.body.classList.remove('sidebar-open');
                    $('sidebar-overlay').classList.add('hidden');
                }
            }
        }

        function saveSession(title = "تمرین جدید") {
            const existingIdx = sessions.findIndex(s => s.id === currentSessionId);
            
            if (currentMessages.length > 0 && title === "تمرین جدید") {
                const first = currentMessages[0].parts[0].text;
                title = first.substring(0, 25) + (first.length > 25 ? '...' : '');
            }

            const data = { id: currentSessionId, title: title, time: Date.now(), msgs: currentMessages };

            if(existingIdx > -1) sessions[existingIdx] = data;
            else sessions.unshift(data);

            if(sessions.length > 30) sessions.pop(); // Limit
            localStorage.setItem('gemini_sessions', JSON.stringify(sessions));
            renderHistory();
        }

        function loadSession(id) {
            const s = sessions.find(x => x.id === id);
            if(!s) return;
            currentSessionId = s.id;
            currentMessages = s.msgs;
            
            $('messages-list').innerHTML = '';
            $('welcome-screen').classList.add('hidden');
            $('messages-list').classList.remove('hidden');
            
            currentMessages.forEach(m => {
                // Manually re-create UI without saving to history again
                renderMessageBubble(m.role, m.parts[0].text);
            });
            
             // Close sidebar on mobile
            if(window.innerWidth < 1024) {
                document.body.classList.add('sidebar-closed');
                document.body.classList.remove('sidebar-open');
                $('sidebar-overlay').classList.add('hidden');
            }
        }

        function renderHistory() {
            const list = $('history-list');
            list.innerHTML = '';
            if(sessions.length === 0) list.innerHTML = '<div class="text-center text-gray-400 text-xs mt-4">خالی</div>';
            
            sessions.forEach(s => {
                const div = document.createElement('div');
                div.className = 'p-3 rounded-lg bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border border-transparent hover:border-blue-200 dark:hover:border-blue-900 group relative transition';
                div.onclick = () => loadSession(s.id);
                div.innerHTML = `
                    <div class="text-sm font-medium text-gray-700 dark:text-gray-200 truncate pr-5">${s.title}</div>
                    <div class="text-[10px] text-gray-400 mt-1">${new Date(s.time).toLocaleDateString('fa-IR')}</div>
                    <button onclick="deleteSession(event, '${s.id}')" class="absolute left-2 top-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                `;
                list.appendChild(div);
            });
        }

        function deleteSession(e, id) {
            e.stopPropagation();
            if(!confirm('حذف شود؟')) return;
            sessions = sessions.filter(s => s.id !== id);
            localStorage.setItem('gemini_sessions', JSON.stringify(sessions));
            if(currentSessionId === id) startNewChat();
            renderHistory();
        }

        // --- API Key Logic ---
        function renderSettingsKeys() {
            const list = $('api-keys-list');
            list.innerHTML = '';
            if(apiKeys.length === 0) apiKeys.push('');
            
            apiKeys.forEach((key, idx) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <input type="radio" name="activeKey" ${idx === activeKeyIndex ? 'checked' : ''} onchange="setActiveKey(${idx})" class="accent-blue-500">
                    <input type="password" value="${key}" onchange="updateKey(${idx}, this.value)" class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2 text-xs font-mono ltr-text" placeholder="API Key">
                    <button onclick="removeKey(${idx})" class="text-red-400 hover:text-red-600 px-2 ${apiKeys.length === 1 ? 'hidden' : ''}"><i class="fa-solid fa-trash"></i></button>
                `;
                list.appendChild(div);
            });
        }
        
        function addApiKeyInput() { apiKeys.push(''); renderSettingsKeys(); }
        function updateKey(idx, val) { apiKeys[idx] = val.trim(); }
        function removeKey(idx) { apiKeys.splice(idx, 1); activeKeyIndex = 0; renderSettingsKeys(); }
        function setActiveKey(idx) { activeKeyIndex = idx; }
        
        function saveSettings() {
            apiKeys = apiKeys.filter(k => k);
            if(apiKeys.length === 0) activeKeyIndex = 0;
            selectedModel = $('model-select').value;
            
            localStorage.setItem('gemini_api_keys', JSON.stringify(apiKeys));
            localStorage.setItem('gemini_active_idx', activeKeyIndex);
            localStorage.setItem('gemini_model', selectedModel);
            
            updateModelBadge();
            closeModal('settings-modal');
        }
        
        function getApiKey() { return apiKeys[activeKeyIndex]; }
        function updateModelBadge() { $('model-badge').innerText = `مدل: ${selectedModel}`; }

        async function fetchModels() {
            const key = getApiKey();
            if(!key) return alert('API Key نیاز است');
            const btn = $('fetch-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ...';
            
            try {
                // Fetch models from Google
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await res.json();
                
                if(data.error) throw new Error(data.error.message);

                // Filter valid content generation models
                const valid = data.models.filter(m => 
                    m.supportedGenerationMethods.includes('generateContent') && 
                    m.name.includes('gemini')
                );
                
                // Sort by version (simple logic)
                valid.sort((a,b) => b.version - a.version);

                const select = $('model-select');
                select.innerHTML = '';
                valid.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.name.replace('models/', '');
                    opt.innerText = `${m.displayName} (${m.name.replace('models/','')})`;
                    select.appendChild(opt);
                });
                alert(`لیست بروز شد! ${valid.length} مدل پیدا شد.`);
            } catch(e) { 
                alert('خطا در دریافت مدل‌ها: ' + e.message); 
            } finally {
                btn.innerHTML = originalText;
            }
        }

        // --- Chat Logic ---
        function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }

        function renderMessageBubble(role, text) {
            $('welcome-screen').classList.add('hidden');
            $('messages-list').classList.remove('hidden');
            
            const list = $('messages-list');
            const div = document.createElement('div');
            const isUser = role === 'user';
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start no-print'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `message-bubble max-w-[95%] sm:max-w-[85%] rounded-2xl p-4 sm:p-5 shadow-sm text-sm sm:text-base leading-7 ${
                isUser 
                ? 'bg-blue-600 text-white rounded-br-none' 
                : 'bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border border-gray-100 dark:border-gray-700 rounded-bl-none'
            }`;

            if(isUser) bubble.innerText = text;
            else {
                bubble.classList.add('prose', 'dark:prose-invert', 'rtl');
                bubble.innerHTML = marked.parse(text);
            }
            
            div.appendChild(bubble);
            list.appendChild(div);
            
            const container = $('chat-container');
            setTimeout(() => container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' }), 50);
        }

        async function processAI(prompt) {
            const key = getApiKey();
            if(!key) return alert('API Key وارد نشده است');
            
            // Loading UI
            const list = $('messages-list');
            const loadDiv = document.createElement('div');
            loadDiv.id = 'loading';
            loadDiv.className = 'flex gap-2 p-4 text-gray-500 items-center no-print';
            loadDiv.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-blue-500"></i> در حال تحلیل و نوشتن...';
            list.appendChild(loadDiv);
            $('chat-container').scrollTo(0, 99999);

            try {
                // Construct payload
                const historyPayload = currentMessages.map(m => ({role: m.role, parts: [{text: m.parts[0].text}]}));
                
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [...historyPayload, {role: 'user', parts: [{text: prompt}]}],
                        systemInstruction: { parts: [{ text: "شما یک مربی فوق تخصص بدنسازی هستید. پاسخ‌ها فارسی، ساختاریافته (با جدول Markdown)، علمی و انگیزشی باشد. اگر درخواست برنامه بود حتما جدول رسم کن." }] }
                    })
                });
                
                const data = await res.json();
                loadDiv.remove();
                
                if(data.error) throw new Error(data.error.message);
                const reply = data.candidates[0].content.parts[0].text;
                
                // Update State & UI
                currentMessages.push({role: 'user', parts: [{text: prompt}]});
                currentMessages.push({role: 'model', parts: [{text: reply}]});
                
                renderMessageBubble('model', reply);
                saveSession();

            } catch(e) {
                loadDiv.remove();
                renderMessageBubble('model', `❌ خطا: ${e.message}`);
            }
        }

        function sendMessage() {
            const txt = $('user-input').value.trim();
            if(!txt) return;
            $('user-input').value = '';
            $('user-input').style.height = 'auto';
            
            if (!currentSessionId) startNewChat();
            
            renderMessageBubble('user', txt);
            processAI(txt);
        }

        function submitPlan() {
            closeModal('plan-modal');
            const p = {
                gender: $('p-gender').value,
                age: $('p-age').value,
                weight: $('p-weight').value,
                height: $('p-height').value,
                level: document.querySelector('input[name="level"]:checked').value,
                goal: $('p-goal').value,
                days: $('p-days').value,
                equip: $('p-equip').value,
                injury: $('p-injury').value,
                explain: $('p-explain').checked
            };
            
            const prompt = `یک برنامه تمرینی حرفه‌ای و جدول‌بندی شده بنویس برای:
            جنسیت: ${p.gender} | سن: ${p.age} | وزن: ${p.weight} | قد: ${p.height}
            سطح: ${p.level} | هدف: ${p.goal}
            تعداد روز: ${p.days} | تجهیزات: ${p.equip}
            آسیب دیدگی: ${p.injury || 'ندارد'}
            ${p.explain ? 'لطفا زیر هر جدول، نحوه صحیح حرکات را آموزش بده.' : ''}
            قالب: جدول Markdown شامل ست، تکرار، استراحت و تمپو.`;
            
            startNewChat();
            renderMessageBubble('user', `درخواست برنامه اختصاصی: ${p.goal} (${p.level})`);
            processAI(prompt);
        }

        // --- EXPORT FUNCTIONS (V3 Logic) ---

        function exportToImage() {
            closeModal('export-modal');
            const element = $('messages-list');
            const originalHeight = element.style.height;
            const originalOverflow = element.style.overflow;
            element.style.height = 'auto';
            element.style.overflow = 'visible';

            html2canvas(element, {
                backgroundColor: document.documentElement.classList.contains('dark') ? '#111827' : '#ffffff',
                scale: 2,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Gemini_Plan_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                element.style.height = originalHeight;
                element.style.overflow = originalOverflow;
            }).catch(err => alert('خطا در تهیه عکس: ' + err));
        }

        function exportToPDF() {
            closeModal('export-modal');
            window.print();
        }

        function exportToHTML() {
            closeModal('export-modal');
            const content = document.documentElement.outerHTML;
            const blob = new Blob([content], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Gemini_Coach_Full_${Date.now()}.html`;
            link.click();
        }

        function exportToText() {
            closeModal('export-modal');
            let text = "";
            currentMessages.forEach(msg => {
                text += `\n[${msg.role === 'user' ? 'شما' : 'مربی'}]:\n${msg.parts[0].text}\n${'-'.repeat(20)}\n`;
            });
            const blob = new Blob([text], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Workout_Plan_${Date.now()}.txt`;
            link.click();
        }

        // Styles for Input
        const inputFields = document.querySelectorAll('.input-field');
        inputFields.forEach(el => {
            el.className = 'w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition text-gray-800 dark:text-gray-200';
        });

    </script>
</body>
</html>


